<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리자 페이지 - 시크릿클래스</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 아이콘 -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Pretendard', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 font-sans p-8">
    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-8">
        <div class="flex justify-between items-center mb-8 border-b pb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">관리자 대시보드</h1>
                <p class="text-gray-500 mt-2">회원 관리 및 결제 승인</p>
            </div>
            <div class="flex gap-4">
                <button onclick="window.refreshList()" class="flex items-center gap-2 bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i> 새로고침
                </button>
                <button onclick="window.logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors font-bold">
                    로그아웃
                </button>
            </div>
        </div>

        <!-- 통계 카드 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-blue-50 p-6 rounded-xl border border-blue-100">
                <h3 class="text-blue-800 font-bold text-sm mb-1">총 회원수</h3>
                <p class="text-3xl font-bold text-blue-900" id="total-users">-</p>
            </div>
            <div class="bg-yellow-50 p-6 rounded-xl border border-yellow-100">
                <h3 class="text-yellow-800 font-bold text-sm mb-1">입금 대기중</h3>
                <p class="text-3xl font-bold text-yellow-900" id="pending-users">-</p>
            </div>
            <div class="bg-green-50 p-6 rounded-xl border border-green-100">
                <h3 class="text-green-800 font-bold text-sm mb-1">결제 완료</h3>
                <p class="text-3xl font-bold text-green-900" id="paid-users">-</p>
            </div>
        </div>

        <div class="overflow-x-auto bg-white rounded-lg border border-gray-200">
            <table class="w-full text-left border-collapse">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="p-4 font-bold text-gray-600 border-b">가입일</th>
                        <th class="p-4 font-bold text-gray-600 border-b">아이디</th>
                        <th class="p-4 font-bold text-gray-600 border-b">이름</th>
                        <th class="p-4 font-bold text-gray-600 border-b">전화번호</th>
                        <th class="p-4 font-bold text-gray-600 border-b">가입경로</th>
                        <th class="p-4 font-bold text-gray-600 border-b text-center">상태</th>
                        <th class="p-4 font-bold text-gray-600 border-b text-center">관리</th>
                    </tr>
                </thead>
                <tbody id="user-table-body" class="divide-y divide-gray-100">
                    <tr><td colspan="7" class="p-8 text-center text-gray-500">데이터를 불러오는 중입니다...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // 관리자 체크
        const checkAdmin = () => {
            const userId = sessionStorage.getItem('sc_user_id');
            if (userId !== 'admin') {
                alert("관리자만 접근할 수 있습니다.");
                window.location.href = 'index.html';
            }
        };
        checkAdmin();

        // 초기화
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                loadUsers();
            } catch (error) {
                console.error("Auth Error:", error);
                alert("DB 연결 실패");
            }
        };
        initAuth();

        // 유저 목록 로드
        async function loadUsers() {
            const tbody = document.getElementById('user-table-body');
            
            try {
                const querySnapshot = await getDocs(collection(db, 'artifacts', appId, 'public', 'data'));
                
                let users = [];
                let pendingCount = 0;
                let paidCount = 0;

                querySnapshot.forEach((doc) => {
                    if (doc.id.startsWith('users_')) {
                        const data = doc.data();
                        users.push(data);
                        if (data.paymentStatus === 'pending') pendingCount++;
                        if (data.paymentStatus === 'paid') paidCount++;
                    }
                });

                // 통계 업데이트
                document.getElementById('total-users').innerText = users.length + "명";
                document.getElementById('pending-users').innerText = pendingCount + "명";
                document.getElementById('paid-users').innerText = paidCount + "명";

                // 최신순 정렬
                users.sort((a, b) => new Date(b.joinedAt) - new Date(a.joinedAt));

                tbody.innerHTML = '';
                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-gray-500">가입한 회원이 없습니다.</td></tr>';
                    return;
                }

                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.className = "hover:bg-gray-50 transition-colors";
                    
                    let statusBadge, actionBtn;

                    if (user.paymentStatus === 'paid') {
                        statusBadge = `<span class="inline-flex items-center gap-1 bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs font-bold"><i data-lucide="check-circle" class="w-3 h-3"></i> 결제완료</span>`;
                        actionBtn = `<button onclick="window.resetStatus('${user.id}')" class="text-xs text-gray-400 hover:text-red-500 underline">취소</button>`;
                    } else if (user.paymentStatus === 'pending') {
                        statusBadge = `<span class="inline-flex items-center gap-1 bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full text-xs font-bold animate-pulse"><i data-lucide="clock" class="w-3 h-3"></i> 입금확인중</span>`;
                        actionBtn = `<button onclick="window.approveUser('${user.id}')" class="bg-indigo-600 text-white px-3 py-1.5 rounded-lg text-sm font-bold hover:bg-indigo-700 shadow-sm transition-all transform hover:scale-105">승인하기</button>`;
                    } else {
                        statusBadge = `<span class="inline-flex items-center gap-1 bg-gray-100 text-gray-500 px-2 py-1 rounded-full text-xs font-medium">미결제</span>`;
                        actionBtn = `<span class="text-gray-300">-</span>`;
                    }

                    row.innerHTML = `
                        <td class="p-4 text-gray-500 text-sm">${user.joinedAt?.split('T')[0]}</td>
                        <td class="p-4 font-medium text-gray-900">${user.id}</td>
                        <td class="p-4 font-bold text-gray-800">${user.name}</td>
                        <td class="p-4 text-gray-600">${user.phone}</td>
                        <td class="p-4 text-gray-500 text-sm"><span class="bg-gray-100 px-2 py-1 rounded">${user.source || '-'}</span></td>
                        <td class="p-4 text-center">${statusBadge}</td>
                        <td class="p-4 text-center">${actionBtn}</td>
                    `;
                    tbody.appendChild(row);
                });
                lucide.createIcons();

            } catch (e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-red-500">데이터 로드 중 오류가 발생했습니다.</td></tr>';
            }
        }

        // 전역 함수 바인딩
        window.refreshList = loadUsers;
        
        window.logout = () => {
            sessionStorage.removeItem('sc_user_id');
            window.location.href = 'index.html';
        };

        window.approveUser = async (userId) => {
            if(!confirm(`${userId} 님의 입금을 승인하시겠습니까?`)) return;
            try {
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users_' + userId);
                await updateDoc(userRef, { paymentStatus: 'paid' });
                alert("승인 처리되었습니다.");
                loadUsers();
            } catch(e) { alert("처리 중 오류 발생"); console.error(e); }
        };

        window.resetStatus = async (userId) => {
            if(!confirm(`${userId} 님의 결제 상태를 취소(미결제) 하시겠습니까?`)) return;
            try {
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users_' + userId);
                await updateDoc(userRef, { paymentStatus: 'unpaid' });
                loadUsers();
            } catch(e) { alert("오류 발생"); }
        };

        // 아이콘 초기화
        if(document.readyState === "loading") document.addEventListener("DOMContentLoaded", () => lucide.createIcons());
        else lucide.createIcons();

    </script>
</body>
</html>