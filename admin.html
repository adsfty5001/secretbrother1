<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>시크릿클래스 관리자</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <header class="bg-white border-b">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="font-extrabold text-gray-900">시크릿클래스 관리자</div>
      <div class="flex items-center gap-2 text-sm">
        <a href="./index.html" class="text-gray-600 hover:text-gray-900">메인으로</a>
        <button id="btn-logout" class="px-3 py-1.5 rounded-lg bg-gray-900 text-white hover:bg-gray-800">로그아웃</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
    <div id="guard" class="p-4 rounded-xl border bg-white">
      <div class="font-bold text-gray-900">접속 확인 중…</div>
      <div class="text-sm text-gray-500 mt-1">관리자 계정으로 로그인되어 있어야 합니다.</div>
    </div>

    <section id="dashboard" class="hidden space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-white border rounded-2xl p-5">
          <div class="text-xs text-gray-500">총 회원수</div>
          <div id="stat-total" class="text-2xl font-extrabold mt-1">-</div>
        </div>
        <div class="bg-white border rounded-2xl p-5">
          <div class="text-xs text-gray-500">결제완료</div>
          <div id="stat-complete" class="text-2xl font-extrabold mt-1">-</div>
        </div>
        <div class="bg-white border rounded-2xl p-5">
          <div class="text-xs text-gray-500">입금확인중</div>
          <div id="stat-pending" class="text-2xl font-extrabold mt-1">-</div>
        </div>
        <div class="bg-white border rounded-2xl p-5">
          <div class="text-xs text-gray-500">미결제</div>
          <div id="stat-none" class="text-2xl font-extrabold mt-1">-</div>
        </div>
      </div>

      <div class="bg-white border rounded-2xl p-5">
        <div class="flex flex-col md:flex-row md:items-end gap-3 justify-between">
          <div class="space-y-2">
            <div class="font-bold text-gray-900">회원 목록</div>
            <div class="text-sm text-gray-500">검색/필터 후 결제상태를 변경할 수 있습니다.</div>
          </div>
          <div class="flex flex-col md:flex-row gap-2">
            <input id="q" class="px-3 py-2 rounded-xl border bg-gray-50 w-full md:w-64" placeholder="검색: 이름/아이디/이메일/단톡방ID" />
            <select id="f-source" class="px-3 py-2 rounded-xl border bg-gray-50">
              <option value="">가입경로: 전체</option>
              <option value="blog">블로그</option>
              <option value="youtube">유튜브</option>
              <option value="etc">기타</option>
            </select>
            <select id="f-pay" class="px-3 py-2 rounded-xl border bg-gray-50">
              <option value="">결제상태: 전체</option>
              <option value="complete">complete</option>
              <option value="pending">pending</option>
              <option value="none">none</option>
            </select>
            <button id="btn-export" class="px-4 py-2 rounded-xl bg-indigo-600 text-white font-bold hover:bg-indigo-700">CSV 내보내기</button>
          </div>
        </div>

        <div class="overflow-x-auto mt-4">
          <table class="min-w-full text-sm">
            <thead class="text-xs text-gray-500">
              <tr class="border-b">
                <th class="text-left py-2 pr-2">가입일</th>
                <th class="text-left py-2 pr-2">이름</th>
                <th class="text-left py-2 pr-2">아이디</th>
                <th class="text-left py-2 pr-2">이메일</th>
                <th class="text-left py-2 pr-2">단톡방ID</th>
                <th class="text-left py-2 pr-2">가입경로</th>
                <th class="text-left py-2 pr-2">결제상태</th>
                <th class="text-left py-2 pr-2">변경</th>
              </tr>
            </thead>
            <tbody id="rows" class="divide-y"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, collection, query, orderBy, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCvFTB5GVkVZLLVilv_hCoJ0Fcjn-w-tyY",
  authDomain: "secretclass-5c9d8.firebaseapp.com",
  projectId: "secretclass-5c9d8",
  storageBucket: "secretclass-5c9d8.firebasestorage.app",
  messagingSenderId: "316837263466",
  appId: "1:316837263466:web:ae28f1110f3728ea8ab213",
  measurementId: "G-8GPZWFNNC6"
  };
  const ADMIN_EMAILS = ["admin@secretclass.com"];

  const app = initializeApp(FIREBASE_CONFIG);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const elGuard = document.getElementById("guard");
  const elDash = document.getElementById("dashboard");
  const elRows = document.getElementById("rows");
  const elQ = document.getElementById("q");
  const elFS = document.getElementById("f-source");
  const elFP = document.getElementById("f-pay");

  document.getElementById("btn-logout").onclick = () => signOut(auth).then(()=>location.href="./index.html");

  let all = [];

  function fmtDate(ts) {
    if(!ts) return "";
    try {
      // Firestore Timestamp
      if(ts.seconds) return new Date(ts.seconds*1000).toISOString().slice(0,10);
    } catch(e){}
    return String(ts).slice(0,10);
  }

  function applyFilters() {
    const q = (elQ.value||"").trim().toLowerCase();
    const fs = elFS.value;
    const fp = elFP.value;

    const filtered = all.filter(u => {
      if(fs && u.joinSource !== fs) return false;
      if(fp && (u.payStatus||"none") !== fp) return false;
      if(!q) return true;
      const blob = [u.name,u.username,u.email,u.chatId].join(" ").toLowerCase();
      return blob.includes(q);
    });

    // stats
    document.getElementById("stat-total").innerText = all.length.toLocaleString();
    document.getElementById("stat-complete").innerText = all.filter(x=>(x.payStatus||"none")==="complete").length.toLocaleString();
    document.getElementById("stat-pending").innerText = all.filter(x=>(x.payStatus||"none")==="pending").length.toLocaleString();
    document.getElementById("stat-none").innerText = all.filter(x=>(x.payStatus||"none")==="none").length.toLocaleString();

    elRows.innerHTML = filtered.map(u => {
      const pay = (u.payStatus||"none");
      return `
        <tr>
          <td class="py-2 pr-2 text-gray-500">${fmtDate(u.createdAt)}</td>
          <td class="py-2 pr-2 font-semibold">${u.name||""}</td>
          <td class="py-2 pr-2">${u.username||""}</td>
          <td class="py-2 pr-2">${u.email||""}</td>
          <td class="py-2 pr-2">${u.chatId||""}</td>
          <td class="py-2 pr-2">${u.joinSource||""}</td>
          <td class="py-2 pr-2"><span class="px-2 py-0.5 rounded-full text-xs ${pay==="complete"?"bg-green-100 text-green-700":pay==="pending"?"bg-yellow-100 text-yellow-700":"bg-gray-100 text-gray-700"}">${pay}</span></td>
          <td class="py-2 pr-2">
            <select data-uid="${u.uid}" class="paySel px-2 py-1 rounded-lg border bg-gray-50 text-xs">
              <option value="none" ${pay==="none"?"selected":""}>none</option>
              <option value="pending" ${pay==="pending"?"selected":""}>pending</option>
              <option value="complete" ${pay==="complete"?"selected":""}>complete</option>
            </select>
          </td>
        </tr>`;
    }).join("");

    document.querySelectorAll(".paySel").forEach(sel => {
      sel.onchange = async (e) => {
        const uid = e.target.getAttribute("data-uid");
        const v = e.target.value;
        if(!uid) return;

        // users/{uid} 와 members/{uid} 둘 다 업데이트
        await updateDoc(doc(db,"users",uid), { payStatus: v });
        await updateDoc(doc(db,"members",uid), { payStatus: v });
        alert("결제상태가 변경되었습니다.");
      };
    });
  }

  elQ.oninput = applyFilters;
  elFS.onchange = applyFilters;
  elFP.onchange = applyFilters;

  document.getElementById("btn-export").onclick = () => {
    const headers = ["createdAt","name","username","email","chatId","joinSource","payStatus"];
    const lines = [headers.join(",")];
    all.forEach(u => {
      const row = headers.map(h => {
        const v = (h==="createdAt") ? fmtDate(u.createdAt) : (u[h]||"");
        const safe = String(v).replaceAll('"','""');
        return `"${safe}"`;
      }).join(",");
      lines.push(row);
    });
    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "members.csv";
    a.click();
    URL.revokeObjectURL(url);
  };

  onAuthStateChanged(auth, (user) => {
    if(!user) {
      elGuard.innerHTML = `<div class="font-bold text-gray-900">로그인이 필요합니다.</div>
        <div class="text-sm text-gray-500 mt-1">메인에서 관리자 계정으로 로그인 후 다시 접속하세요.</div>`;
      elDash.classList.add("hidden");
      return;
    }
    const isAdmin = ADMIN_EMAILS.includes(String(user.email||"").toLowerCase());
    if(!isAdmin) {
      elGuard.innerHTML = `<div class="font-bold text-gray-900">권한이 없습니다.</div>
        <div class="text-sm text-gray-500 mt-1">관리자 이메일이 아닙니다: ${user.email||""}</div>`;
      elDash.classList.add("hidden");
      return;
    }

    elGuard.classList.add("hidden");
    elDash.classList.remove("hidden");

    onSnapshot(query(collection(db,"members"), orderBy("createdAt","desc")), (snap) => {
      all = [];
      snap.forEach(d => all.push({ uid: d.id, ...d.data() }));
      applyFilters();
    }, (err) => {
      elRows.innerHTML = `<tr><td class="py-6 text-center text-red-600" colspan="8">members 읽기 권한이 없습니다: ${err.code}</td></tr>`;
    });
  });
</script>
</body>
</html>
