<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>나의 강의실 - 시크릿클래스</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Optional: centralized Firebase config for GitHub Pages -->
  <script src="./js/config.js"></script>
</head>
<body class="bg-gray-50">
  <header class="bg-white border-b">
    <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
      <a href="./index.html" class="font-extrabold text-gray-900">시크릿클래스</a>
      <button id="btn-logout" class="px-3 py-1.5 rounded-lg bg-gray-900 text-white hover:bg-gray-800 text-sm">로그아웃</button>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-6 space-y-6">
    <div id="guard" class="p-5 rounded-2xl border bg-white">
      <div class="font-bold text-gray-900">접속 확인 중…</div>
      <div class="text-sm text-gray-500 mt-1">로그인/수강 상태를 확인하고 있습니다.</div>
    </div>

    <section id="room" class="hidden space-y-4">
      <div class="bg-white border rounded-2xl p-5">
        <div class="text-sm text-gray-500">회원</div>
        <div id="me" class="text-lg font-extrabold mt-1">-</div>
        <div id="status" class="text-sm text-gray-600 mt-1">-</div>
      </div>

      <div class="bg-white border rounded-2xl p-5">
        <div class="font-bold text-gray-900 mb-2">강의 목록</div>
        <div class="text-sm text-gray-500 mb-4">현재는 기본 틀만 구성되어 있습니다. (courses 컬렉션을 연결하면 자동 노출)</div>
        <div id="courses" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
      </div>
    </section>
  </main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    collection,
    query,
    orderBy,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  const firebaseConfig = (window.FIREBASE_CONFIG && typeof window.FIREBASE_CONFIG === "object")
    ? window.FIREBASE_CONFIG
    : {
apiKey: "AIzaSyCvFTB5GVkVZLLVilv_hCoJ0Fcjn-w-tyY",
  authDomain: "secretclass-5c9d8.firebaseapp.com",
  projectId: "secretclass-5c9d8",
  storageBucket: "secretclass-5c9d8.firebasestorage.app",
  messagingSenderId: "316837263466",
  appId: "1:316837263466:web:ae28f1110f3728ea8ab213",
  measurementId: "G-8GPZWFNNC6"
    };

  const APP_ID = window.APP_ID || "secretclass";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const P = {
    userProfile: (uid) => doc(db, "artifacts", APP_ID, "users", uid, "profile", "info"),
    coursesCol: () => collection(db, "artifacts", APP_ID, "public", "data", "courses"),
  };

  const elUserEmail = document.getElementById("user-email");
  const elPay = document.getElementById("pay-status");
  const elGate = document.getElementById("pay-gate");
  const elCourses = document.getElementById("courses");
  const elLogout = document.getElementById("btn-logout");

  elLogout?.addEventListener("click", async () => {
    await signOut(auth);
    window.location.href = "./index.html";
  });

  const showGate = (msg) => {
    if (elPay) elPay.textContent = msg || "";
    if (elGate) elGate.classList.remove("hidden");
    if (elCourses) elCourses.classList.add("hidden");
  };

  const showCourses = () => {
    if (elGate) elGate.classList.add("hidden");
    if (elCourses) elCourses.classList.remove("hidden");
  };

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "./index.html";
      return;
    }

    if (elUserEmail) elUserEmail.textContent = user.email || "";

    try {
      const snap = await getDoc(P.userProfile(user.uid));
      const payStatus = snap.exists() ? String(snap.data()?.payStatus || "") : "";

      if (payStatus !== "active") {
        showGate(payStatus ? `결제 상태: ${payStatus}` : "결제 상태: 미설정");
        return;
      }

      showCourses();

      if (!elCourses) return;
      const qy = query(P.coursesCol(), orderBy("createdAt", "desc"));
      onSnapshot(qy, (snap2) => {
        const items = [];
        snap2.forEach(d => items.push({ id: d.id, ...d.data() }));
        if (items.length === 0) {
          elCourses.innerHTML = `<div class="text-gray-500">강의 목록이 아직 등록되지 않았습니다.</div>`;
          return;
        }
        elCourses.innerHTML = items.map(c => `
          <a class="block bg-white border rounded-xl p-4 hover:shadow" href="${c.url || "#"}" target="_blank" rel="noopener noreferrer">
            <div class="font-bold text-gray-900">${c.title || "강의"}</div>
            <div class="text-sm text-gray-600 mt-1">${c.desc || ""}</div>
          </a>
        `).join("");
      }, (err) => {
        console.warn("courses read skipped:", err?.code || err);
      });
    } catch (e) {
      console.error(e);
      showGate("결제 상태 확인에 실패했습니다. 잠시 후 다시 시도해 주세요.");
    }
  });</script>
</body>
</html>
